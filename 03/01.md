# 03. 도커 친화적인 애플리케이션
컨테이너 제어, 설정의 관점에서 이식성 높은 애플리케이션의 몇 가지 특성이 있음

## 환경 변수 활용
* **애플리케이션 개발** : 재사용성 및 유연성을 위해 **옵션에 따라 애플리케이션 동작 제어**
* 도커 환경은 이식성이 중요하므로, 외부에서 옵션 전달로 동작 제어가 가능해야 함

### 애플리케이션 동작 제어 방법
* [실행 시 인자](#방법-1-실행-시-인자-사용)
* [설정 파일](#방법-2-설정-파일-사용)
* [애플리케이션 동작을 환경 변수로 제어](#방법-3-애플리케이션-동작을-환경-변수로-제어)
* **[설정 파일에 환경 변수 포함](#방법-4-설정-파일에-환경-변수-포함)** (책에서 가장 추천)

***

### 방법 1. 실행 시 인자 사용
인스트럭션(`CMD`, `ENTRYPOINT`)으로 컨테이너 실행 시 수행할 명령을 지정하는 방법 외에 인자 형태로 값을 전달하는 방법이 있음
```
$ example
```
* **장점** : 외부에서 값을 주입할 수 있음
* **단점** : 인자가 너무 많을 때
    * 애플리케이션에서 내부 변수로 매핑 처리가 복잡해짐
    * 인스트럭션 내용 관리가 어려움
* 실행 시 필요한 인자를 잘 선택하는 능력이 필요

### 방법 2. 설정 파일 사용
컨테이너 보급 이전에도 널리 사용되는 방식
* 실행할 애플리케이션에 development/production 등 환경 이름 부여 후 환경에 맞는 설정 파일 사용
* **예** : 루비 온 레일즈, 자바(Maven, Gradle 사용)
    
#### 설정 파일을 사용하는 앱을 도커 컨테이너로 전환 할 때
1. **도커 이미지를 설정 파일 별로 만들어둠** : 다른 환경에서 실행하려면 설정 파일을 추가해서 새로 빌드해야 하는 번거로움
2. **호스트의 설정파일을 컨테이너에 마운트** : 호스트에 대한 의존성이 생겨 관리/운영이 불편
3. **설정 파일을 컨테이너 밖에서 실행 시 전달** : 실행 환경을 추가해도 새로 빌드할 필요가 없음

### 방법 3. 애플리케이션 동작을 환경 변수로 제어
[젠킨스 예제](https://github.com/devSoyoung/docker-kubernetes-study/blob/master/02/06.md#%EC%8A%AC%EB%A0%88%EC%9D%B4%EB%B8%8C-%EC%A0%A0%ED%82%A8%EC%8A%A4-%EC%BB%A8%ED%85%8C%EC%9D%B4%EB%84%88-%EC%83%9D%EC%84%B1)에서 사용했던 **JENKINS_SLAVE_SSH_PUBKEY** 환경변수와 같은 방법

* **장점** : 설정이 바뀌어도 이미지를 다시 빌드할 필요가 없음
* **단점** : 환경변수의 특성(키-값 쌍의 형태)으로 인해 계층 구조를 가지기 어려움
* **환경변수 관리** : 애플리케이션과 별도의 레파지토리에서 관리하는 것이 일반적
    * **컴포즈 사용 시** : `docker-compose.yml`의 **environment** 속성에 기술
    * 쿠버네티스나 아마존 ECS에도 비슷한 기능을 제공하고 있음

> 매핑 처리의 어려움 해결을 위해 Go 언어는 콤마로 구분한 환경 변수 값을 배열로 매핑해주는 kelseyhightower/envconfig 라는 라이브러리가 있음

### 방법 4. 설정 파일에 환경 변수 포함
환경별 설정 파일을 애플리케이션에 포함하고, 설정 파일 템플릿에 환경 변수를 포함
* 환경 변수의 장점과 설정 파일의 장점을 모두 취한 방법
* **예** : 스프링 프레임워크의 properties 파일은 환경 변수를 포함할 수 있음
    * 환경변수 미포함 설정파일 : 환경 가짓수만큼 설정 파일을 만들어야 함
    * 환경변수 포함 설정파일 : 해당 파일을 템플릿으로 사용

```
db.driverClass=${DB_DRIVER_CLASS:com.mysql.jdbc.Driver}
db.jdbcUrl=${DB_JDBC_URL}
db.user=${DB_USER}
```

> 모든 애플리케이션 프레임워크가 지원하지 않음. 컨테이너 친화적 애플리케이션 제작에 유리한 프레임워크인지 평가할 때 좋은 지표가 될 수 있음.
